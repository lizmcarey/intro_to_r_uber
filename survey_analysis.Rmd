---
title: "R Notebook"
output: html_notebook
---

## Setup 
First things, first. Let's load all the necessary libraries we'll need! 

```{r setup}
library(tidyverse)
library(summarytools)
library(here) # Find current working directory and directories of files
library(skimr) # View summary statistics
library(janitor) # R functions to find duplicate values

```


##Load survey data

You have 1 of two options to load the survey data. You can use the File drop down, then click on `Import Dataset`, then `From Text (readr)` and follow the UI to import the data. 

Alternatively, if you know the file path, you can read the data set using the code below

```{r}
#store the file path name
file_name <- "survey_file.csv"

#read the survey data, name the dataframe `df`
df <- read_csv(here::here("Data", file_name))
```
Let's preview the survey data
```{r}
View(df)
```

We can see that the first two rows are unncessary to reading the data. When we load the data, we can tell R to skip adding those first two lines into the data frame. 

Try this with the Import UI, and/or try doing this by reading the readr documentation and writing your own code
```{r}
?read_csv

df_raw <- read_csv(here::here("Data", file_name),
                   skip = 2)

view(df_raw)
```
We've managed to exclude the metadata from our dataframe, but now the column names don't seem to make sense! 

What we'll need to do instead is store the column names in a seperate variable, then read it back in to the data frame. 
```{r}
#store column names
df_names <- read_csv(here::here("Data", file_name), n_max=0) %>% names()

# Read the entire file
df_raw <- read_csv(here::here("Data", file_name), 
               col_names = df_names, # use df_names to title the columns
               skip = 3)             # skip the first three lines
View(df_raw)
```

Let's use `skim()` to get an overview of our data set

```{r}
skim(df_raw)
```
Now, let's try using the package `summarytools` to view our data set. 

```{r}
dfSummary(df_raw)

#same code, but more readable in the Viewer pane
view(dfSummary(df_raw))
```
What do you notice? We can see the min and max of the start dates for the survey, we can see that Q4 has 7 missing values, Q6 has 54 mising values, 41% of the responses came from ci = 1, and there are 12 of the same email in column `e.` 

This report is helpful in seeing if there are any anomolies or large missing values in the dataset. Sometime this report will catch whether we've read the data incorrectly and stop us before we analyze a broken data set. 

The columns `ci` and `e` might not be easily understood from other people trying to read your code. Let's rename the column

```{r}
df_raw <- 
  df_raw %>% 
    rename(city_id = ci)

df_raw
```

From the summary report, it looks like we saw some duplicate emails. Let's count how many duplicates there are. 

```{r}
df_raw %>% 
  group_by(e) %>% 
  count() %>% 
  arrange(desc(n))
```
This time, let's use the `janitor` package to find duplciate emails. 

```{r}
df_raw %>% 
  get_dupes(e)
```

Let's delete the duplicate emails, and keep their first response

```{r}
#Remove duplicate emails, keep the first submission date
df_raw <- df_raw %>% 
  group_by(e) %>% 
  slice(which.min(StartDate)) %>% 
  ungroup()
```

Let's double check that we've removed all of the duplciates

```{r}
df_raw %>% 
  get_dupes(e)
  
```
We can also see that the number of observations in df_raw is 1025, meaning 32 of the duplicate emails have been removed. 

We also have some demographic data of the respondents that lives in the Data folder in the file called, "demos.csv"

Let's read in the demo's csv as "demo_data"

```{r}
demo_data <- read_csv(here::here("Data", "demos.csv"))
```

Now, let's create one merged table by joining the `df_raw` table with the `demo_data` table and call if `df`

```{r}
#Uncomment the code and run it
# df_raw %>% 
#   left_join(demo_data)
```
Why did this error out? Turns out R doesn't know what unique key to join the two tables. We can either rename the `e` column in `df_raw` to `email` or we can tell the `left_join()` function which columns to merge on. 

```{r}
#option 1: rename column `e` to `email`
df_raw %>% 
  rename(email = e) %>% 
  left_join(demo_data)

#option 2: tell left_join which columns to join by
df_raw %>% 
  left_join(demo_data, by = c("e" = "email"))

df_raw <- 
  df_raw %>% 
  left_join(demo_data, by = c("e" = "email"))
```

Use `dfSummary` to quickview the data set. 

```{r}
view(dfSummary(df_raw))
```

Now we can see `df_raw` has a few new columns like gender, age, and firstname. 

Let's analyze Question 1! 

```{r}
calc_moe <- function(p,n, z=1.96){
  x <- z*sqrt(p*(1-p)/n)
  return(x)
}


Q1_table <- df_raw %>% 
  group_by(Q1) %>% 
  summarize(n = n()) %>% 
  mutate(total = sum(n), 
         proportion = (n/total), 
         moe = calc_moe(proportion, total), 
         lower = proportion - moe, 
         upper = proportion + moe
  )
         
Q1_table

```
Let's plot the frequency table using ggplot! 

```{r}
Q1_table %>% 
  ggplot(aes(x = Q1, y = proportion)) + 
  geom_col()
```
Hmm, looks like we want to reorder the bars from the order in which the response options were shown. 

Let's relabel them. 
```{r}
Q1_table <- 
  Q1_table %>% 
  mutate(Q1 = 
          fct_relevel(Q1, 
                      "Daily", 
                      "2-6 times a week",
                      "Once a week", 
                      "2-3 times a month", 
                      "Once a month or less")
  ) 

Q1_table %>% 
  ggplot(aes(x = Q1, y = proportion)) + 
  geom_col()
```
Now let's get fancy

```{r}
Q1_table %>% 
  ggplot(aes(x = Q1, y = proportion)) + 
  geom_col(fill = "#EA7580") + 
  geom_errorbar(
    aes(ymin = lower, ymax = upper), 
    size = .5, 
    width = 0, 
    position = position_dodge(.7)
  ) + 
  geom_text(aes(label = paste0(round(proportion*100), "%"), y = upper), vjust = -.3) + 
  labs (
    title = "Q1", 
    subtitle = "How often do you order food delivery?", 
    caption = glue("Error bars represent 95% confidence intervals\nn = {Q1_table$total}")
  ) + 
  scale_y_continuous(labels = scales::percent) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10))

```
```{r}
Q2_table <- df_raw %>% 
  group_by(Q2) %>% 
  summarize(n = n()) %>% 
  mutate(total = sum(n), 
         proportion = (n/total), 
         moe = calc_moe(proportion, total), 
         lower = proportion - moe, 
         upper = proportion + moe
  )

Q2_table
```
```{r}
Q2_table %>% 
  ggplot(aes(x = Q2, y = proportion)) + 
  geom_col(fill = "#EA7580") + 
  geom_errorbar(
    aes(ymin = lower, ymax = upper), 
    size = .5, 
    width = 0, 
    position = position_dodge(.7)
  ) + 
  geom_text(aes(label = paste0(round(proportion*100), "%"), y = upper), vjust = -.3) + 
  labs (
    title = "Q2", 
    subtitle = "How many food delivery apps do you have installed on your phone?", 
    caption = glue("Error bars represent 95% confidence intervals\nn = {Q2_table$total}")
  ) + 
  scale_y_continuous(labels = scales::percent) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10))
```
Multi-select questions require different code to analyze from the way it's stored. 

```{r}
Q3_table <- df_raw %>% 
  select(starts_with("Q3")) %>% 
  gather(question, response, na.rm=TRUE) %>% 
  group_by(response) %>% 
  summarize(n = n()) %>% 
  mutate(total = sum(n), 
         proportion = (n/total), 
         moe = calc_moe(proportion, total), 
         lower = proportion - moe, 
         upper = proportion + moe
  )

Q3_table
```

```{r}
Q3_table %>% 
  ggplot(aes(x = response, y = proportion)) + 
  geom_col(fill = "#EA7580") + 
  geom_errorbar(
    aes(ymin = lower, ymax = upper), 
    size = .5, 
    width = 0, 
    position = position_dodge(.7)
  ) + 
  geom_text(aes(label = paste0(round(proportion*100), "%"), y = upper), vjust = -.3) + 
  labs (
    title = "Q2", 
    subtitle = "How many food delivery apps do you have installed on your phone?", 
    caption = glue("Error bars represent 95% confidence intervals\nn = {Q2_table$total}")
  ) + 
  scale_y_continuous(labels = scales::percent) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10))
```
Let's reorder this by frequency

```{r}
Q3_table %>% 
  ggplot(aes(x = reorder(response, -proportion), y = proportion)) + 
  geom_col(fill = "#EA7580") + 
  geom_errorbar(
    aes(ymin = lower, ymax = upper), 
    size = .5, 
    width = 0, 
    position = position_dodge(.7)
  ) + 
  geom_text(aes(label = paste0(round(proportion*100), "%"), y = upper), vjust = -.3) + 
  labs (
    x = "Q3",
    title = "Q3", 
    subtitle = "Which of the following are reasons why you order food delivery? Select all that apply.", 
    caption = glue("Error bars represent 95% confidence intervals\nn = {Q3_table$total}")
  ) + 
  scale_y_continuous(labels = scales::percent) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 15))
```
Let's do Q4

```{r}
Q4_table <- df_raw %>% 
  group_by(Q4) %>% 
  summarize(n = n()) %>% 
  mutate(total = sum(n), 
         proportion = (n/total), 
         moe = calc_moe(proportion, total), 
         lower = proportion - moe, 
         upper = proportion + moe
  )

Q4_table
```
We notice that 7 counts are `NA.` Let's be sure to remove these null values from our total n size. 

```{r}
Q4_table <- 
  df_raw %>% 
  filter(!is.na(Q4)) %>% 
  group_by(Q4) %>% 
  summarize(n = n()) %>% 
  mutate(total = sum(n), 
         proportion = (n/total), 
         moe = calc_moe(proportion, total), 
         lower = proportion - moe, 
         upper = proportion + moe
  )

Q4_table
```

```{r}
Q4_table %>% 
  ggplot(aes(x = reorder(Q4, -proportion), y = proportion)) + 
  geom_col(fill = "#EA7580") + 
  geom_errorbar(
    aes(ymin = lower, ymax = upper), 
    size = .5, 
    width = 0, 
    position = position_dodge(.7)
  ) + 
  geom_text(aes(label = paste0(round(proportion*100), "%"), y = upper), vjust = -.3) + 
  labs (
    x = "Q4",
    title = "Q4", 
    subtitle = "Which of the following best describes your most recent food delivery cuisine?", 
    caption = glue("Error bars represent 95% confidence intervals\nn = {Q4_table$total}")
  ) + 
  scale_y_continuous(labels = scales::percent) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10))
```

```{r}
Q5_table <- df_raw %>% 
  group_by(Q5) %>% 
  summarize(n = n()) %>% 
  mutate(total = sum(n), 
         proportion = (n/total), 
         moe = calc_moe(proportion, total), 
         lower = proportion - moe, 
         upper = proportion + moe
  ) %>% 
  mutate(Q5 = 
          fct_relevel(Q5, 
                      "Extremely dissatisfied", 
                      "Somewhat dissatisfied", 
                      "Neither satisfied nor dissatisfied", 
                      "Somewhat satisfied", 
                      "Extremely satisfied")
  )

Q5_table
```

```{r}
Q5_table %>% 
  ggplot(aes(x = Q5, y = proportion)) + 
  geom_col(fill = "#EA7580") + 
  geom_errorbar(
    aes(ymin = lower, ymax = upper), 
    size = .5, 
    width = 0, 
    position = position_dodge(.7)
  ) + 
  geom_text(aes(label = paste0(round(proportion*100), "%"), y = upper), vjust = -.3) + 
  labs (
    title = "Q5", 
    subtitle = "How satisfied or dissatisfied are you with your most recent food delivery order?", 
    caption = glue("Error bars represent 95% confidence intervals\nn = {Q5_table$total}")
  ) + 
  scale_y_continuous(labels = scales::percent) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 20))
```
Sometimes our stakeholders are only interested in the Top 2 Boxes. Let's calculate them quickly. 


```{r}
Q5_table_top2 <- 
  df_raw %>% 
  mutate(Q5 = case_when(
      Q5 %in% c("Extremely dissatisfied","Somewhat dissatisfied") ~ "Dissatisfied",
      Q5 %in% c("Extremely satisfied", "Somewhat satisfied") ~ "Satisfied", 
      Q5 == "Neither satisfied nor dissatisfied" ~ "Neither"
    )) %>% 
  group_by(Q5) %>% 
  summarize(n = n()) %>% 
  mutate(total = sum(n), 
         proportion = (n/total), 
         moe = calc_moe(proportion, total), 
         lower = proportion - moe, 
         upper = proportion + moe
)
    

Q5_table_top2
    
```

```{r}
Q5_table_top2 %>% 
  ggplot(aes(x = Q5, y = proportion)) + 
  geom_col(fill = "#EA7580") + 
  geom_errorbar(
    aes(ymin = lower, ymax = upper), 
    size = .5, 
    width = 0, 
    position = position_dodge(.7)
  ) + 
  geom_text(aes(label = paste0(round(proportion*100), "%"), y = upper), vjust = -.3) + 
  labs (
    title = "Q5", 
    subtitle = "How satisfied or dissatisfied are you with your most recent food delivery order?", 
    caption = glue("Error bars represent 95% confidence intervals\nn = {Q5_table$total}")
  ) + 
  scale_y_continuous(labels = scales::percent) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 20))
```
If you remember that we used the `janitor` package earlier, you'll see they have a function to quickly analyze top2 boxes. Try the function `top_levels()`

```{r}
top_levels(Q5_table$Q5)

top_levels(Q5_table$Q5, n = 1)
```

```{r}
Q6_table <- df_raw %>% 
  group_by(Q6) %>% 
  summarize(n = n()) %>% 
  mutate(total = sum(n), 
         proportion = (n/total), 
         moe = calc_moe(proportion, total), 
         lower = proportion - moe, 
         upper = proportion + moe
  ) 

Q6_table
```
Looks like 66 people skipped this question. We want the proportion of those who *answered* the question. So let's remove those who skipped the question from our total n size. 

```{r}
Q6_table <- df_raw %>% 
  filter(!is.na(Q6)) %>% #remove null rows from this question
  group_by(Q6) %>% 
  summarize(n = n()) %>% 
  mutate(total = sum(n), 
         proportion = (n/total), 
         moe = calc_moe(proportion, total), 
         lower = proportion - moe, 
         upper = proportion + moe
  ) 

Q6_table
```
Notice how the total is now 991? We removed the 66 null rows. 

```{r}
Q6_table %>% 
  ggplot(aes(x = reorder(Q6, -proportion), y = proportion)) + 
  geom_col(fill = "#EA7580") + 
  geom_errorbar(
    aes(ymin = lower, ymax = upper), 
    size = .5, 
    width = 0, 
    position = position_dodge(.7)
  ) + 
  geom_text(aes(label = paste0(round(proportion*100), "%"), y = upper), vjust = -.3) + 
  labs (
    x = "Q6",
    title = "Q6", 
    subtitle = "How did you complete your most recent food delivery order?", 
    caption = glue("Error bars represent 95% confidence intervals\nn = {Q6_table$total}")
  ) + 
  scale_y_continuous(labels = scales::percent) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 20))
```

```{r}
Q7_table <-  
  df_raw %>% 
  select(starts_with("Q7"), -ends_with("TEXT")) %>% 
  gather(question, 
         response) %>% 
  group_by(question) %>% 
  count(question, 
        response) %>% 
  mutate(
    total = sum(n),
    proportion = n/sum(n),
    moe = calc_moe(proportion, total), 
         lower = proportion - moe, 
         upper = proportion + moe) %>% 
  filter(!is.na(response))

Q7_table
```

```{r}
Q7_table %>% 
  ggplot(aes(x = reorder(response, -proportion), y = proportion)) + 
  geom_col(fill = "#EA7580") + 
  geom_errorbar(
    aes(ymin = lower, ymax = upper), 
    size = .5, 
    width = 0, 
    position = position_dodge(.7)
  ) + 
  geom_text(aes(label = paste0(round(proportion*100), "%"), y = upper), vjust = -.3) + 
  labs (
    x = "Q7",
    title = "Q7", 
    subtitle = "How could your most recent food delivery experience been improved? Select all that apply.", 
    caption = glue("Error bars represent 95% confidence intervals\nn = {Q7_table$total}")
  ) + 
  scale_y_continuous(labels = scales::percent) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 20))
```

Let's save this chart as a png so we can include it in a presentation. 

```{r}
ggsave("Q7_plot.png")

```

